<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>DCA Historical Annexations Table</title>
  <link rel="stylesheet" href="https://js.arcgis.com/3.21/dijit/themes/claro/claro.css">
  <link rel="stylesheet" href="https://js.arcgis.com/3.21/esri/css/esri.css">
  <script src="https://js.arcgis.com/3.21/"></script>

  <style>
    html,
    body,
    #myTableNode {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: "Arial", sans-serif;
    }

    #top,
    #bot {
      margin: 0;
      padding: 0;
    }

    .esri-feature-table-menu {
      background-color: #fff !important;
      color: #fff !important;
    }

    th[role="columnheader"] {
      background-color: rgb(32, 60, 76) !important;
      color: #fff !important;
      border-bottom: 2px solid #8DD3EE !important;
    }

    #search {
      display: block;
      position: absolute;
      z-index: 3;
      top: 20px;
      left: 75px;
    }
    .search-label {
      position: absolute;
      left: 75px;
      top: 0;
      background: white;
      z-index: 4;
      font-size: 1em;
      padding: 2px 6px;
      color: #203c4c;
      border-radius: 4px 4px 0 0;
      border-bottom: 1px solid #8DD3EE;
    }
    .search-clear-btn {
      position: absolute;
      left: 350px;
      top: 24px;
      z-index: 4;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 2px 8px;
      cursor: pointer;
    }
  </style>
</head>

<body class="claro">
  <div class="search-label">Combined Filter: Enter City and/or County</div>
  <div id="search"></div>
  <button id="clearFilterBtn" class="search-clear-btn">Clear Filters</button>
  <div id="myTableNode"></div>

  <script>
    require([
      "esri/layers/FeatureLayer",
      "esri/dijit/FeatureTable",
      "dojo/dom",
      "dojo/io-query",
      "dojo/ready"
    ], function (
      FeatureLayer, FeatureTable, dom, ioQuery, ready
    ) {

      function getAnchor() {
        var currentUrl = document.URL,
          urlParts = currentUrl.split('#');
        return (urlParts.length > 1) ? urlParts[1] : null;
      }

      function getQuery() {
        return dojo.doc.location.search.slice(1)
      }

      function getOptions() {
        var params = getAnchor();
        if (params === null) {
          params = getQuery();
        }
        return ioQuery.queryToObject(decodeURIComponent(params));
      }

      // Helper to escape single quotes for SQL
      function escapeSQL(str) {
        return str ? str.replace(/'/g, "''") : "";
      }

      ready(function () {
        var options = getOptions();

        // Check for required parameters
        if (!options.url || !options.outFields || !options.hiddenFields) {
          alert("Missing required parameters (url, outFields, hiddenFields) in URL fragment or query string.");
          return;
        }

        var myFeatureLayer = new FeatureLayer(options.url, {
          mode: FeatureLayer.MODE_ONDEMAND,
          outFields: options.outFields.split(','),
          visible: true,
          id: "fLayer"
        });

        var myTable = new FeatureTable({
          featureLayer: myFeatureLayer,
          showGridMenu: true,
          hiddenFields: options.hiddenFields.split(',')
        }, "myTableNode");
        myTable.startup();

        // --- Custom Combined Filter UI ---
        // Build two input boxes for city/county filtering
        var searchDiv = dom.byId("search");

        // Create City input
        var cityInput = document.createElement("input");
        cityInput.type = "text";
        cityInput.placeholder = "City";
        cityInput.style.width = "120px";
        cityInput.style.marginRight = "10px";
        cityInput.id = "cityInput";

        // Create County input
        var countyInput = document.createElement("input");
        countyInput.type = "text";
        countyInput.placeholder = "County";
        countyInput.style.width = "120px";
        countyInput.id = "countyInput";

        // Create Filter button
        var filterBtn = document.createElement("button");
        filterBtn.innerText = "Apply Filter";
        filterBtn.style.marginLeft = "12px";
        filterBtn.onclick = applyCombinedFilter;

        searchDiv.appendChild(cityInput);
        searchDiv.appendChild(countyInput);
        searchDiv.appendChild(filterBtn);

        // Clear button (shown at top for convenience)
        document.getElementById("clearFilterBtn").onclick = function() {
          cityInput.value = "";
          countyInput.value = "";
          myFeatureLayer.setDefinitionExpression("");
        };

        // Main filter function
        function applyCombinedFilter() {
          var cityVal = cityInput.value.trim();
          var countyVal = countyInput.value.trim();
          var clauses = [];
          if (cityVal.length > 0) {
            clauses.push("City LIKE '%" + escapeSQL(cityVal) + "%'");
          }
          if (countyVal.length > 0) {
            clauses.push("County LIKE '%" + escapeSQL(countyVal) + "%'");
          }
          var expr = clauses.join(" AND ");
          myFeatureLayer.setDefinitionExpression(expr);
        }

        // Allow pressing Enter in either box to filter
        cityInput.addEventListener("keyup", function(event) {
          if (event.key === "Enter") applyCombinedFilter();
        });
        countyInput.addEventListener("keyup", function(event) {
          if (event.key === "Enter") applyCombinedFilter();
        });

      });
    });
  </script>
</body>

</html>
