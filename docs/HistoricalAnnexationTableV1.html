<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>DCA Historical Annexations Table</title>
  <link rel="stylesheet" href="https://js.arcgis.com/3.21/dijit/themes/claro/claro.css">
  <link rel="stylesheet" href="https://js.arcgis.com/3.21/esri/css/esri.css">
  <script src="https://js.arcgis.com/3.21/"></script>
  <style>
    html, body, #myTableNode {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: "Arial", sans-serif;
    }
    th[role="columnheader"] {
      background-color: rgb(32, 60, 76) !important;
      color: #fff !important;
      border-bottom: 2px solid #8DD3EE !important;
    }
    #searchBarContainer {
      display: flex;
      align-items: center;
      gap: 10px;
      position: absolute;
      z-index: 3;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      width: 100%;
      max-width: 100vw;
      background: white;
      border-radius: 0 0 4px 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      padding: 7px 16px;
      box-sizing: border-box;
    }
    #searchBarContainer > * {
      box-sizing: border-box;
    }
    #searchBarContainer input[type="text"] {
      max-width: 250px;
      width: 100%;
    }
    #searchBarContainer button {
      min-width: 60px;
    }
  </style>
</head>
<body class="claro">
  <div id="searchBarContainer">
    <span style="font-size: 1em; color: #203c4c;">Search City or County:</span>
    <div id="search" style="display:inline-block; min-width: 200px; flex: 1 1 250px;"></div>
  </div>
  <div id="myTableNode"></div>

  <script>
    require([
      "esri/layers/FeatureLayer",
      "esri/dijit/FeatureTable",
      "esri/dijit/Search",
      "dojo/dom",
      "dojo/io-query",
      "dojo/ready"
    ], function (
      FeatureLayer, FeatureTable, Search, dom, ioQuery, ready
    ) {

      function getAnchor() {
        var currentUrl = document.URL,
          urlParts = currentUrl.split('#');
        return (urlParts.length > 1) ? urlParts[1] : null;
      }

      function getQuery() {
        return dojo.doc.location.search.slice(1);
      }

      function getOptions() {
        var params = getAnchor();
        if (params === null) {
          params = getQuery();
        }
        return ioQuery.queryToObject(decodeURIComponent(params));
      }

      // Helper to escape single quotes for SQL
      function escapeSQL(str) {
        return str ? str.replace(/'/g, "''") : "";
      }

      ready(function () {
        var options = getOptions();

        // Check for required parameters
        if (!options.url || !options.outFields || !options.hiddenFields) {
          alert("Missing required parameters (url, outFields, hiddenFields) in URL fragment or query string.");
          return;
        }

        // Create the feature layer
        var myFeatureLayer = new FeatureLayer(options.url, {
          mode: FeatureLayer.MODE_ONDEMAND,
          outFields: options.outFields.split(','),
          visible: true,
          id: "fLayer"
        });

        var myTable = new FeatureTable({
          featureLayer: myFeatureLayer,
          showGridMenu: true,
          hiddenFields: options.hiddenFields.split(',')
        }, "myTableNode");
        myTable.startup();

        // Esri Search Widget
        var search = new Search({
          map: null,
          enableButtonMode: false,
          enableLabel: false,
          enableInfoWindow: false,
          showInfoWindowOnSelect: false,
          sources: [
            {
              featureLayer: myFeatureLayer,
              searchFields: ["City", "County"],
              displayField: "City",
              exactMatch: false,
              outFields: ["*"],
              name: "City or County",
              placeholder: "Search by City or County"
            }
          ]
        }, dom.byId("search"));
        search.startup();

        function refreshTable() {
          myTable.refresh();
          myTable.resize();
        }

        // Filter table when a result is selected (from suggestion list)
        search.on("select-result", function (e) {
          var searchTerm = e.value || "";
          var safeVal = escapeSQL(searchTerm.trim());
          if (!safeVal) {
            myFeatureLayer.setDefinitionExpression("");
            refreshTable();
            return;
          }
          // Filter for exact match (use LIKE for partial, = for exact)
          var city = e.result.feature.attributes.City;
          var county = e.result.feature.attributes.County;
          var expr = "";
          if (city && (!county || county === "")) {
            expr = "City = '" + escapeSQL(city) + "'";
          } else if (county && (!city || city === "")) {
            expr = "County = '" + escapeSQL(county) + "'";
          } else if (city && county) {
            expr = "(City = '" + escapeSQL(city) + "' OR County = '" + escapeSQL(county) + "')";
          } else {
            expr = "City LIKE '%" + safeVal + "%' OR County LIKE '%" + safeVal + "%'";
          }
          myFeatureLayer.setDefinitionExpression(expr);
          refreshTable();
        });

        // Also filter when user enters a search and presses Enter
        search.on("search", function (e) {
          var searchTerm = e.value || "";
          var safeVal = escapeSQL(searchTerm.trim());
          if (!safeVal) {
            myFeatureLayer.setDefinitionExpression("");
            refreshTable();
            return;
          }
          // Filter for partial match in City or County
          var expr = "City LIKE '%" + safeVal + "%' OR County LIKE '%" + safeVal + "%'";
          myFeatureLayer.setDefinitionExpression(expr);
          refreshTable();
        });

        // Remove filter when search is cleared
        search.on("clear-search", function () {
          myFeatureLayer.setDefinitionExpression("");
          refreshTable();
        });
      });
    });
  </script>
</body>
</html>
